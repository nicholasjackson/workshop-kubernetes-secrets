# Defining secrets with the Vault Secrets Operator

Let's now see how we can use the Vault Secrets Operator to sync the secrets
we created in the previous section with Kubernetes.

1. Create a Service Account that Vault will use to authenticate with Kubernetes.
2. Create a Vault role that maps the Service Account to a Vault policy.
3. Create a VaultAuth CRD that defines the authentication method to use.
4. Create a VaultSecret CRD that defines the secrets to sync with Kubernetes. 

```hcl
# create a service account for the app, this allows the vault operator to 
# authenticate the app to vault and retrieve the secrets
resource "kubernetes_service_account" "minecraft" {
  metadata {
    name = "minecraft-${var.environment}"
  }
}
```

```hcl
resource "kubernetes_secret" "minecraft-token" {
  metadata {
    name = "${kubernetes_service_account.minecraft.metadata.0.name}-token"
    annotations = {
      "kubernetes.io/service-account.name" = kubernetes_service_account.minecraft.metadata.0.name
    }
  }

  type = "kubernetes.io/service-account-token"
}
```

```hcl
resource "vault_policy" "minecraft_secrets" {
  name = "minecraft-secrets"

  policy = <<EOF
  path "${vault_database_secrets_mount.minecraft.path}/creds/reader" {

    capabilities = ["read", "create", "update"]
  }
  EOF
}
```

```hcl
resource "vault_kubernetes_auth_backend_role" "minecraft" {
  backend   = "kubernetes"
  role_name = "minecraft"

  bound_service_account_names      = [kubernetes_service_account.minecraft.metadata.0.name]
  bound_service_account_namespaces = ["default"]
  token_policies                   = [vault_policy.minecraft_secrets.name]
}
```

```hcl
resource "kubernetes_manifest" "vaultauth_dev_auth" {
  manifest = {
    "apiVersion" = "secrets.hashicorp.com/v1beta1"
    "kind"       = "VaultAuth"
    "metadata" = {
      "name"      = "dev-auth"
      "namespace" = "default"
    }
    "spec" = {
      "allowedNamespaces" = [
        "*",
      ]
      "kubernetes" = {
        "role"                   = vault_kubernetes_auth_backend_role.minecraft.role_name
        "serviceAccount"         = kubernetes_service_account.minecraft.metadata.0.name
        "tokenExpirationSeconds" = 600
      }
      "method"             = "kubernetes"
      "mount"              = "kubernetes"
      "vaultConnectionRef" = "default"
    }
  }
}
```

```hcl
resource "kubernetes_manifest" "vault_dynamic_secret" {
  manifest = {
    "apiVersion" = "secrets.hashicorp.com/v1beta1"
    "kind"       = "VaultDynamicSecret"
    "metadata" = {
      "name"      = "minecraft-db"
      "namespace" = "default"
    }
    "spec" = {
      "mount"     = vault_database_secrets_mount.minecraft.path
      "path"      = "creds/reader"

      "destination" = {
        "create" = true
        "name"   = "minecraft-db"
      }
      "vaultAuthRef" = "dev-auth"
    }
  }
}
```