# Syncing Vault Secrets With Kubernetes

In the previous sections, you have seen how to create roles and generate credentials 
for a PostgreSQL database using Vault. In this section, you will learn how to 
sync these credentials with a Kubernetes cluster.

There are several ways to inject secrets into your Kubernetes applications.  
These are:

### Vault Agent Injector

The Vault Agent Injector is a controller and sidecar container that runs 
alongside your application it allows you to define configuration application 
specific configuration files that specify which secrets to inject into your 
application using Vault Template.

<details>
  <summary style=\{{ fontSize: '18px', color: 'rgb(84, 128, 178)', fontWeight: 'medium' }} >Example deployment using Vault Injector</summary>

```yaml
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: app-example
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: app-example-deployment
spec:
  replicas: 1
  selector:
    matchLabels:
      app: app-example
  template:
    metadata:
      labels:
        app: app-example
      annotations:
        vault.hashicorp.com/agent-inject: 'true'
        vault.hashicorp.com/agent-inject-secret-db-creds: 'database/creds/db-app'
        vault.hashicorp.com/agent-inject-template-db-creds: |
          \{{- with secret "database/creds/db-app" -}}
          postgres://\{{ .Data.username }}:\{{ .Data.password }}@postgres:5432/appdb?sslmode=disable
          \{{- end }}
        vault.hashicorp.com/role: 'db-app'
        vault.hashicorp.com/ca-cert: '/vault/tls/ca.crt'
        vault.hashicorp.com/client-cert: '/vault/tls/client.crt'
        vault.hashicorp.com/client-key: '/vault/tls/client.key'
        vault.hashicorp.com/tls-secret: 'vault-tls-client'
    spec:
      containers:
        - name: app
          image: 'app:1.0.0'
      serviceAccountName: app-example
```

</details>

### Vault CSI Provider 

The Vault CSI Provider is a Kubernetes CSI Secrets Store driver that allows
you to mount secrets stored in Vault into your Kubernetes applications as
volumes and also sync them with Kubernetes secrets.

<details>
  <summary style=\{{ fontSize: '18px', color: 'rgb(84, 128, 178)', fontWeight: 'medium' }} >Example deployment using Vault CSI Provider</summary>

```yaml
---
apiVersion: secrets-store.csi.x-k8s.io/v1alpha1
kind: SecretProviderClass
metadata:
  name: vault-db-creds
spec:
  # Vault CSI Provider
  provider: vault
  parameters:
    # Vault role name to use during login
    roleName: 'app'
    objects: |
      - objectName: "dbUsername"
        secretPath: "database/creds/db-app"
        secretKey: "username"
      - objectName: "dbPassword"
        secretPath: "database/creds/db-app"
        secretKey: "password"
    # "objectName" is an alias used within the SecretProviderClass to reference
    # that specific secret. This will also be the filename containing the secret.
    # "secretPath" is the path in Vault where the secret should be retrieved.
    # "secretKey" is the key within the Vault secret response to extract a value from.

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: app
  labels:
    app: demo
spec:
  selector:
    matchLabels:
      app: demo
  replicas: 1
  template:
    spec:
      serviceAccountName: app
      containers:
        - name: app
          image: my-app:1.0.0
          volumeMounts:
            - name: 'vault-db-creds'
              mountPath: '/mnt/secrets-store'
              readOnly: true
      volumes:
        - name: vault-db-creds
          csi:
            driver: 'secrets-store.csi.k8s.io'
            readOnly: true
            volumeAttributes:
              secretProviderClass: 'vault-db-creds'
```
</details>

### Vault Secrets Operator

Finally there is the Vault Secrets Operator which is a Kubernetes operator that
enables you to define manage your Vault secrets as Custom Resource Definitions CRDs
and to sync these to Kubernetes secrets.

This is the most flexible and powerful way to sync your Vault secrets with Kubernetes
and the method that we will be using in this workshop.

Let's get started.

